<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Triathlon Trainingsplan – Sprint</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --text:#e9eef6; --muted:#a8b3c7; --accent:#7dd3fc;
      --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --line:rgba(255,255,255,.10); --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      padding:14px 14px 160px;
      max-width:980px; margin:0 auto;
    }
    header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin:4px 0 12px}
    h1{margin:0;font-size:18px;font-weight:900}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4}
    .pillRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{font-size:12px;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .pill strong{color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .cardHeader{padding:12px 12px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.12)}
    .cardHeader h2{margin:0;font-size:14px;font-weight:900}
    .cardBody{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; font-size:13px; cursor:pointer;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent; user-select:none;
      transition:.12s transform ease;
    }
    button:active{transform:scale(.98)}
    .btnPrimary{background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.08));border-color:rgba(125,211,252,.35)}
    .btnWarn{background:linear-gradient(180deg, rgba(251,191,36,.20), rgba(251,191,36,.07));border-color:rgba(251,191,36,.35)}
    .kicker{font-size:12px;font-weight:900;color:rgba(125,211,252,.95);text-transform:uppercase}
    .bigDay{font-size:18px;font-weight:950;margin:0}
    .smallDate{font-size:12px;color:var(--muted);margin:0}
    .todayTitle{display:flex;flex-direction:column;gap:2px}
    .section{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.10);margin-bottom:10px}
    .section h3{margin:0 0 8px;font-size:13px;font-weight:950}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Inputs (WICHTIG): Standard-Inputs ja, aber Checkbox NICHT */
    textarea,select,input{
      width:100%;
      background:rgba(0,0,0,.20);
      border:1px solid var(--line);
      border-radius:14px;
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:92px;resize:vertical}

    /* ✅ FIX 1: Checkbox darf NICHT width:100% haben */
    input[type="checkbox"]{
      width:auto !important;
      padding:0 !important;
      border-radius:6px;
      background:transparent;
      border:1px solid var(--line);
      accent-color: var(--accent);
    }

    ul{margin:8px 0 0 18px;padding:0;line-height:1.35}
    li{margin:5px 0}

    .checklist{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .checkItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:flex-start;
      width:100%;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04)
    }
    .checkItem input[type="checkbox"]{
      margin-top:4px;
      flex:0 0 auto;
      transform:scale(1.15);
    }
    .checkMain{
      flex:1 1 auto;
      min-width:0;
    }
    .t{font-weight:950;font-size:13px;margin:0}
    .d{margin:2px 0 0;font-size:12px;color:var(--muted);white-space:pre-wrap}
    .hintTap{margin-top:6px;font-size:11px;color:rgba(125,211,252,.9);font-weight:900}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;font-weight:950;cursor:pointer}
    .tab.active{background:rgba(125,211,252,.16);border-color:rgba(125,211,252,.35)}

    .weekTable{width:100%;border-collapse:separate;border-spacing:0;border-radius:16px;border:1px solid var(--line);overflow:hidden}
    .weekTable th,.weekTable td{padding:10px;text-align:left;vertical-align:top;border-bottom:1px solid var(--line);font-size:12px;white-space:pre-wrap}
    .weekTable th{background:rgba(255,255,255,.06);font-weight:950}
    .weekTable tr:last-child td{border-bottom:none}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);font-size:12px;font-weight:950}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

    .footerBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(10,14,20,.86); backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      display:flex;justify-content:center;z-index:50
    }
    .footerBar .inner{width:min(980px,100%);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tiny{font-size:11px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .banner{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px 12px;
      margin: 0 0 12px;
    }
    .statusOk{color:var(--good);font-weight:900}
    .statusBad{color:var(--bad);font-weight:900}
    .statusWarn{color:var(--warn);font-weight:900}
    pre{margin:0;white-space:pre-wrap;font-family:inherit;color:var(--muted)}

    /* ---- Modal ---- */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:16px;
      z-index:100;
    }
    .modal{
      width:min(880px,100%);
      max-height: 90vh;              /* ✅ FIX 2: begrenzte Höhe */
      display:flex;                  /* ✅ FIX 2: Header + Body sauber */
      flex-direction:column;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      position:sticky; top:0;        /* ✅ FIX 2: X bleibt immer sichtbar */
      z-index:3;
    }
    .modalHeader h3{margin:0;font-size:14px;font-weight:950}
    .modalClose{
      min-width:44px;
      position:sticky; top:10px;
      z-index:4;
    }
    .modalBody{
      padding:12px;
      overflow:auto;                 /* ✅ FIX 2: nur Body scrollt */
      -webkit-overflow-scrolling: touch;
    }
    .modalBody .small{margin-top:6px}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:12px;border:1px solid var(--line);background:rgba(0,0,0,.14);padding:6px 10px;border-radius:999px}
    .strong{font-weight:950;color:var(--text)}
    .kbd{font-family:ui-monospace,monospace;border:1px solid var(--line);padding:2px 6px;border-radius:8px;background:rgba(0,0,0,.18);font-size:12px}
    .searchRow{display:flex;gap:10px;align-items:center}
    .libList{display:flex;flex-direction:column;gap:8px}
    .libItem{
      padding:10px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);
      cursor:pointer;
    }
    .libItem .name{font-weight:950;font-size:13px;margin:0}
    .libItem .meta{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:pre-wrap}
  </style>
</head>
<body>

<div class="banner">
  <div class="row" style="justify-content:space-between">
    <div>
      <div style="font-weight:950">Status</div>
      <div class="small mono" id="statusLine">JS lädt…</div>
    </div>
    <div class="row">
      <button class="btnPrimary" id="btnReload" type="button">Neu laden</button>
    </div>
  </div>
  <div class="small" id="errorLine" style="margin-top:6px"></div>
</div>

<header>
  <div>
    <h1>Triathlon Trainingsplan – Sprint</h1>
    <p class="sub">Tippe in der Checkliste auf eine Einheit → du bekommst eine Schritt-für-Schritt-Anleitung. Schwimmtechnik rotiert alle 2 Wochen, Laufdauer steigt automatisch.</p>
    <div class="pillRow">
      <div class="pill"><strong>Swim:</strong> 25m Bahn · Technik = Effizienz/Tempo-Stabilität</div>
      <div class="pill"><strong>Bike GA1:</strong> 130–165 W</div>
      <div class="pill"><strong>Run Easy:</strong> HR/RPE geführt (bei dir ~5:20@160 ok)</div>
      <div class="pill"><strong>Knie:</strong> flach · keine Sprints · Stop-Regeln</div>
    </div>
  </div>
  <div class="row">
    <button class="btnPrimary" id="btnToday" type="button">Heute</button>
    <button id="btnPrev" type="button">←</button>
    <button id="btnNext" type="button">→</button>
  </div>
</header>

<div class="grid">
  <section class="card">
    <div class="cardHeader">
      <div class="todayTitle">
        <div class="kicker">Heute</div>
        <p class="bigDay" id="todayDay">—</p>
        <p class="smallDate" id="todayDate">—</p>
      </div>
      <div class="badge"><span class="dot" id="loadDot"></span><span id="loadText">—</span></div>
    </div>

    <div class="cardBody">
      <div class="section">
        <h3>Was steht an?</h3>
        <div class="small" id="todaySummary">—</div>
        <div class="divider"></div>
        <div class="row">
          <div class="badge">Dauer: <span id="todayDuration">—</span></div>
          <div class="badge">Fokus: <span id="todayFocus">—</span></div>
        </div>
      </div>

      <div class="section">
        <h3>Umplanen (nur dieses Datum)</h3>
        <div class="small">Restday setzen oder eine andere Einheit anzeigen.</div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btnWarn" id="btnSetRest" type="button">Heute: Restday</button>
          <button id="btnClearOverride" type="button">Override löschen</button>
        </div>
        <div style="height:10px"></div>
        <select id="overrideSelect"></select>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btnPrimary" id="btnApplyOverride" type="button">Übernehmen</button>
          <span class="tiny" id="overrideState">—</span>
        </div>
      </div>

      <div class="section">
        <h3>Details / Ablauf (Gesamt)</h3>
        <div id="todayDetails">—</div>
      </div>

      <div class="section">
        <h3>Checkliste (antippen → Anleitung)</h3>
        <div class="small">Tipp: Tippe auf den <span class="kbd">Namen</span> einer Einheit, nicht auf die Checkbox.</div>
        <div class="checklist" id="checklist"></div>
      </div>

      <div class="section">
        <h3>Notizen</h3>
        <textarea id="notes" placeholder="Wie war’s? Zeiten/Watt/HR? Knie (0–10)?"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btnPrimary" id="btnSave" type="button">Speichern</button>
          <button id="btnClearNotes" type="button">Notiz löschen</button>
          <span class="tiny" id="saveHint">—</span>
        </div>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="cardHeader">
      <h2>Übersicht</h2>
      <div class="tabs">
        <div class="tab active" data-tab="week">Woche</div>
        <div class="tab" data-tab="swim">Schwimmen</div>
        <div class="tab" data-tab="lib">Bibliothek</div>
      </div>
    </div>
    <div class="cardBody">
      <div id="tab-week">
        <table class="weekTable">
          <thead><tr><th style="width:84px">Tag</th><th>Einheiten</th><th style="width:120px">Dauer</th></tr></thead>
          <tbody id="weekRows"></tbody>
        </table>
      </div>

      <div id="tab-swim" style="display:none">
        <div class="section">
          <h3>Variable Schwimmtechnik (Rotation alle 2 Wochen)</h3>
          <div class="small" id="swimRotationInfo">—</div>
          <div class="divider"></div>
          <div class="small">Du kannst in der Tages-Checkliste auf „Schwimmen Mittwoch/Freitag“ tippen → dann siehst du den aktuell rotierenden Technikblock.</div>
        </div>
      </div>

      <div id="tab-lib" style="display:none">
        <div class="section">
          <h3>Bibliothek (alles klickbar)</h3>
          <div class="small">Suche nach „Mobility“, „Scull“, „Run“, „Bike“… tippen öffnet die genaue Anleitung.</div>
          <div style="height:10px"></div>
          <div class="searchRow">
            <input id="libSearch" placeholder="Suche…" />
            <button id="libClear" type="button">X</button>
          </div>
        </div>
        <div class="libList" id="libList"></div>
      </div>
    </div>
  </aside>
</div>

<div class="footerBar">
  <div class="inner">
    <div class="tiny" id="footerHint">—</div>
    <div class="row">
      <button class="btnPrimary" id="btnExport" type="button">Export</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h3 id="modalTitle">—</h3>
        <div class="chipRow" id="modalChips"></div>
      </div>
      <button class="modalClose" id="modalClose" type="button">✕</button>
    </div>
    <div class="modalBody">
      <div class="small" id="modalIntro">—</div>
      <div class="divider"></div>
      <div id="modalContent">—</div>
      <div class="divider"></div>
      <div class="small" id="modalRules">—</div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  function $(id){ return document.getElementById(id); }
  function safeText(el, txt){ if(el) el.textContent = txt; }
  function safeHTML(el, html){ if(el) el.innerHTML = html; }
  function pad2(n){ return (n<10 ? "0" : "") + n; }
  function toISODate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
  function addDays(d, n){ var x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
  function fmtDate(d){
    try{ return d.toLocaleDateString("de-DE",{weekday:"long",year:"numeric",month:"2-digit",day:"2-digit"}); }
    catch(e){ return d.toDateString(); }
  }
  function loadLabel(load){
    if((load||"").indexOf("leicht")>=0) return {text:"Belastung: leicht", cls:"good"};
    if((load||"").indexOf("moderat")>=0) return {text:"Belastung: moderat", cls:"warn"};
    return {text:"Belastung: hoch", cls:"bad"};
  }

  var statusLine = $("statusLine");
  var errorLine  = $("errorLine");

  function setStatusOK(msg){ safeHTML(statusLine, '<span class="statusOk">'+msg+'</span>'); }
  function setStatusWARN(msg){ safeHTML(statusLine, '<span class="statusWarn">'+msg+'</span>'); }
  function setStatusBAD(msg){ safeHTML(statusLine, '<span class="statusBad">'+msg+'</span>'); }

  window.onerror = function(msg, url, line){
    safeText(errorLine, "JS Fehler: " + msg + (line ? (" (Zeile " + line + ")") : ""));
    setStatusBAD("JS Fehler ❌ – siehe Meldung");
    return false;
  };
  window.onunhandledrejection = function(e){
    safeText(errorLine, "JS Promise-Fehler: " + (e && e.reason ? (e.reason.message || String(e.reason)) : "unknown"));
    setStatusBAD("JS Fehler ❌ – siehe Meldung");
  };

  function onReady(fn){
    if(document.readyState === "loading"){ document.addEventListener("DOMContentLoaded", fn); }
    else { fn(); }
  }

  onReady(function(){
    var requiredIds = [
      "btnReload","btnToday","btnPrev","btnNext","btnSetRest","btnClearOverride","btnApplyOverride","overrideSelect",
      "todayDay","todayDate","todaySummary","todayDuration","todayFocus","loadDot","loadText","todayDetails","checklist",
      "notes","btnSave","btnClearNotes","saveHint","weekRows","footerHint","btnExport","tab-week","tab-swim","tab-lib",
      "modalOverlay","modalClose","modalTitle","modalChips","modalIntro","modalContent","modalRules",
      "libSearch","libClear","libList","swimRotationInfo","overrideState"
    ];
    for(var i=0;i<requiredIds.length;i++){
      if(!$(requiredIds[i])){
        safeText(errorLine, "Fehlendes Element im HTML: #" + requiredIds[i] + " (bitte kompletten Code kopieren)");
        setStatusBAD("JS Fehler ❌ – HTML unvollständig");
        return;
      }
    }

    var storageOK = true;
    try{ localStorage.setItem("__tri_test__", "1"); localStorage.removeItem("__tri_test__"); }
    catch(e){ storageOK = false; }

    if(storageOK){ setStatusOK("JS aktiv ✅ | Speicher bereit ✅"); safeText(errorLine,""); }
    else { setStatusWARN("JS aktiv ✅ | Speicher blockiert ⚠️"); }

    // ---------------- Rotation (Swim) ----------------
    var SWIM_ANCHOR = new Date(2025,0,6);
    function daysBetween(a,b){
      var ms = 24*60*60*1000;
      var aa = new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime();
      var bb = new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();
      return Math.floor((bb-aa)/ms);
    }
    function swimCycleIndex(date){
      var d = Math.max(0, daysBetween(SWIM_ANCHOR, date));
      return Math.floor(d/14);
    }

    var SWIM_TECH_BLOCKS = [
      {
        name:"Block A (Catch + Ellbogen hoch)",
        drills:[
          {name:"Fingertip Drag", cue:"Finger streifen Wasser, Ellbogen hoch, Schultern locker."},
          {name:"Scull #1", cue:"Vorne Wasser fühlen, kleine Bewegungen, konstanter Druck."},
          {name:"Scull #2", cue:"Etwas weiter hinten im Catch, Druck nach hinten halten."}
        ]
      },
      {
        name:"Block B (Rotation + Stabilität)",
        drills:[
          {name:"6-Kick-Switch", cue:"6 Beinschläge Seite, sauberer Wechsel, Kopf ruhig."},
          {name:"Catch-Up (moderat)", cue:"Länge halten ohne Stop – Rhythmus flüssig."},
          {name:"Single-Arm (abwechselnd)", cue:"Stabiler Rumpf, Zugbahn sauber, Atmung ruhig."}
        ]
      },
      {
        name:"Block C (Tempo-Stabilität)",
        drills:[
          {name:"3-3-3 (3 Züge links/3 rechts/3 normal)", cue:"Kontrollierte Rotation, Symmetrie."},
          {name:"Build 25s (locker→zügig)", cue:"Tempo aus Technik, nicht aus Hektik."},
          {name:"Fäuste (kurz)", cue:"Wassergefühl im Unterarm, danach normal = besserer Catch."}
        ]
      }
    ];

    function getCurrentSwimBlock(date){
      var idx = swimCycleIndex(date) % SWIM_TECH_BLOCKS.length;
      return SWIM_TECH_BLOCKS[idx];
    }

    // ---------------- Laufprogression ----------------
    var RUN_BASE_MIN = 30;
    var RUN_STEP_MIN = 5;
    var RUN_MAX_MIN  = 55;

    function doneKeyFor(iso){ return "tri_"+iso+"_doneLib"; }

    function countCompleted(libKey, lookbackDays, refDate){
      var ms = 24*60*60*1000;
      var count = 0;
      for(var i=0;i<lookbackDays;i++){
        var d = new Date(refDate.getTime() - i*ms);
        var iso = toISODate(d);
        var raw = getLS(doneKeyFor(iso));
        if(!raw) continue;
        try{
          var arr = JSON.parse(raw);
          if(Array.isArray(arr) && arr.indexOf(libKey) >= 0) count++;
        }catch(e){}
      }
      return count;
    }

    function runMinutesFor(date){
      var completed = countCompleted("run_easy", 56, date);
      var steps = Math.floor(completed / 2);
      var minutes = Math.min(RUN_MAX_MIN, RUN_BASE_MIN + steps*RUN_STEP_MIN);
      return minutes;
    }

    // -------------- Base Library --------------
    var LIB_BASE = {
      "mobility_reha": {
        title: "Mobility / Reha (Bauernfeind-App)",
        chips: ["10–15 min", "Ziel: Knie ruhig", "Qualität > Menge"],
        intro: "Ziel: Gelenke 'schmieren', Spannung rausnehmen, Knie beruhigen.",
        content:
          "<div class='section'><h3>So machst du’s</h3>" +
          "<ul>" +
          "<li>Bauernfeind-App → Knie/Reha-Programm</li>" +
          "<li>Intensität: leicht bis moderat</li>" +
          "<li>Alles mit Sprüngen/Quick Turns: skippen</li>" +
          "</ul></div>" +
          "<div class='section'><h3>Mini-Check</h3>" +
          "<ul><li>Schmerz ≤ 2/10</li><li>Danach besser als vorher</li></ul></div>",
        rules: "Stop: stechender Schmerz oder zunehmendes Ziehen in der Kniekehle."
      },
      "strength_bw": {
        title: "Bodyweight Kraft (Triathlon-Basis)",
        chips: ["~30 min", "Beinachse + Core", "kontrolliert"],
        intro: "Ziel: stabiler Rumpf + stabile Beinachse (Knie schützen).",
        content:
          "<div class='section'><h3>Warm-up (3–4 min)</h3><ul>" +
          "<li>1 min Gehen auf der Stelle</li>" +
          "<li>Hüft/Schulterkreisen</li>" +
          "<li>Air Squat klein, schmerzfrei</li>" +
          "</ul></div>" +
          "<div class='section'><h3>Hauptteil</h3><ul>" +
          "<li><span class='strong'>Split Squat isometrisch</span>: 3×30–45s/Seite</li>" +
          "<li><span class='strong'>Glute Bridge</span>: 3×10–12 (oben 2s)</li>" +
          "<li><span class='strong'>Dead Bug</span>: 3×8/Seite</li>" +
          "<li><span class='strong'>Side Plank</span>: 2–3×30–45s/Seite</li>" +
          "<li><span class='strong'>Wadenheben</span>: 3×12–15</li>" +
          "</ul></div>",
        rules: "Wenn Kniekehle zieht: Bewegungsweg kleiner, langsamer, isometrisch bevorzugen."
      },
      "bike_ga1": {
        title: "Rad GA1 (Basis, gleichmäßig)",
        chips: ["60–75 min", "130–165 W", "rpm 85–95"],
        intro: "Ziel: Aerobe Basis ohne Stress.",
        content:
          "<div class='section'><h3>Ablauf</h3><ul>" +
          "<li>10 min einrollen: 120–140 W</li>" +
          "<li>40–55 min GA1: <span class='strong'>130–165 W</span></li>" +
          "<li>5–10 min ausrollen</li>" +
          "</ul></div>",
        rules: "Gleichmäßig – kein Heldentum."
      },
      "bike_long": {
        title: "Lange Ausfahrt (GA1)",
        chips: ["2–3 h", "130–165 W", "Fueling!"],
        intro: "Ziel: Ausdauer + ökonomisches Treten.",
        content:
          "<div class='section'><h3>Ablauf</h3><ul>" +
          "<li>15 min locker einrollen</li>" +
          "<li>Hauptteil: <span class='strong'>130–165 W</span></li>" +
          "<li>10–15 min ausrollen</li>" +
          "</ul></div>" +
          "<div class='section'><h3>Fueling</h3><ul>" +
          "<li>40–70 g Carbs pro Stunde</li>" +
          "<li>Trinken alle 10–15 min</li>" +
          "</ul></div>",
        rules: "Watt senken wenn nötig, aber Dauer halten."
      },
      "brick_optional": {
        title: "Optionaler Koppellauf nach Rad",
        chips: ["5–10 min", "nur wenn Knie 0–1/10", "super locker"],
        intro: "Nur Gewöhnung – kein Training.",
        content:
          "<div class='section'><h3>Ablauf</h3><ul>" +
          "<li>5–10 min sehr locker traben</li>" +
          "<li>Flach, Kadenz hoch, kein Tempo</li>" +
          "</ul></div>",
        rules: "Wenn irgendwas meckert: weglassen."
      }
    };

    function runEasyLib(date){
      var minutes = runMinutesFor(date);
      var mainMin = Math.max(15, minutes - 10);
      return {
        title: "Lauf easy (knieschonend, HR/RPE geführt)",
        chips: [minutes+" min gesamt", "flach", "Kadenz 165–172"],
        intro: "Easy bei dir kann ~5:20/km @160 bpm sein. Wichtiger: flach & rund, ohne Druck.",
        content:
          "<div class='section'><h3>Ablauf (heute: "+minutes+" min)</h3><ul>" +
          "<li>5–8 min Gehen + sehr lockeres Traben</li>" +
          "<li>"+mainMin+" min easy (RPE 3–4/10; reden möglich)</li>" +
          "<li>2–3 min auslaufen/gehen</li>" +
          "</ul></div>" +
          "<div class='section'><h3>Stop-Regeln</h3><ul>" +
          "<li>Schmerz >2/10 → gehen</li>" +
          "<li>Kniekehle zieht zunehmend → abbrechen</li>" +
          "</ul></div>",
        rules: "Progression: alle 2 erledigten Runs +5 min (max 55)."
      };
    }

    function drillLine(d){ return "<li><span class='strong'>"+d.name+"</span>: "+d.cue+"</li>"; }

    function swimWedLib(date){
      var block = getCurrentSwimBlock(date);
      return {
        title: "Schwimmen Mittwoch (55 min) – GA + Technik",
        chips: ["~2200–2500 m", "25m Becken", "Rotation: "+block.name],
        intro: "Technik: Catch/Druck, Rhythmus, Tempo stabil. Technikblock rotiert alle 2 Wochen.",
        content:
          "<div class='section'><h3>1) Einschwimmen</h3><ul><li>300 m locker (Kraul)</li></ul></div>" +
          "<div class='section'><h3>2) Technikblock: 6×50 (25 Drill + 25 Swim)</h3><ul>" +
          drillLine(block.drills[0])+drillLine(block.drills[1])+drillLine(block.drills[2])+
          "</ul><div class='small'>Pause 15–20s. Qualität, nicht ballern.</div></div>" +
          "<div class='section'><h3>3) Hauptset 4×300</h3><ul>" +
          "<li>300 m @ 1:38–1:42/100</li><li>Pause 25–40s</li></ul></div>" +
          "<div class='section'><h3>4) Zügig 6×50</h3><ul>" +
          "<li>50 m @ ~1:30–1:33/100</li><li>Pause 20s</li></ul></div>" +
          "<div class='section'><h3>5) Ausschwimmen</h3><ul><li>200 m locker</li></ul></div>",
        rules: "Wenn müde: 300er +10s/100 langsamer. Ziel: stabil."
      };
    }

    function swimFriLib(date){
      var block = getCurrentSwimBlock(date);
      return {
        title: "Schwimmen Freitag (55 min) – Key Swim",
        chips: ["~2300–2600 m", "25m Becken", "Rotation: "+block.name],
        intro: "Key Swim: Struktur + kurze schnelle Reize, ohne Hektik.",
        content:
          "<div class='section'><h3>1) Einschwimmen</h3><ul><li>300 m locker</li></ul></div>" +
          "<div class='section'><h3>2) Technik: 4×50 (25 Drill + 25 Swim)</h3><ul>" +
          drillLine(block.drills[0])+drillLine(block.drills[1])+
          "</ul><div class='small'>Pause 15–20s.</div></div>" +
          "<div class='section'><h3>3) Hauptset 5×300</h3><ul>" +
          "<li>300 m @ 1:38–1:43/100</li><li>Pause 25–45s</li></ul></div>" +
          "<div class='section'><h3>4) Schnell 6×25</h3><ul>" +
          "<li>25 m schnell, sauber, lang</li><li>Pause 20–30s</li></ul></div>" +
          "<div class='section'><h3>5) Ausschwimmen</h3><ul><li>200 m locker</li></ul></div>",
        rules: "Wenn Schultern dicht: 25er weglassen."
      };
    }

    function LIB_FOR_DATE(date){
      var out = {};
      for(var k in LIB_BASE) out[k] = LIB_BASE[k];
      out["run_easy"] = runEasyLib(date);
      out["swim_wed"] = swimWedLib(date);
      out["swim_fri"] = swimFriLib(date);
      return out;
    }

    // --------- WEEK STRUCTURE ----------
    var days = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

    function buildPlanForDate(date){
      var runMin = runMinutesFor(date);
      var runDesc = "Flach, Kadenz 165–172. Heute: "+runMin+" min gesamt.";
      var block = getCurrentSwimBlock(date);
      var rotName = block.name;

      return {
        1:{focus:"Regeneration + Kraft",duration:"40–45 min",load:"leicht",summary:"Bodyweight + Mobility.",
          details:"• Bodyweight 30 min (kontrolliert)\n• Mobility 10–15 min (Bauernfeind)",
          checklist:[
            {t:"Bodyweight Kraft (30 min)",d:"Beinachse + Core, kontrolliert.",libKey:"strength_bw"},
            {t:"Mobility/Reha (10–15 min)",d:"Bauernfeind-App, leicht bis moderat.",libKey:"mobility_reha"}
          ]},
        2:{focus:"Lauf + Core",duration:"70–75 min",load:"moderat",summary:"Lauf easy + Core/Beinachse + Mobility.",
          details:"• Lauf "+runMin+" min HR/RPE easy\n• Core/Beinachse 30 min\n• Mobility 10 min",
          checklist:[
            {t:"Lauf easy ("+runMin+" min)",d:runDesc,libKey:"run_easy"},
            {t:"Bodyweight Kraft (30 min)",d:"Core + Beinachse (kontrolliert).",libKey:"strength_bw"},
            {t:"Mobility/Reha (10 min)",d:"Bauernfeind-App (kurz).",libKey:"mobility_reha"}
          ]},
        3:{focus:"Schwimmen + Tennis",duration:"ca. 3 h",load:"hoch",summary:"Schwimmen 55 min (Rotation) + Tennis 2 h.",
          details:"• Swim Mittwoch 55 min ("+rotName+")\n• Tennis 2 h",
          checklist:[
            {t:"Schwimmen Mittwoch (55 min)",d:"GA + Technik (Rotation: "+rotName+").",libKey:"swim_wed"},
            {t:"Tennis 2 h",d:"Warm-up ordentlich, danach auslaufen/gehen 3–5 min.",libKey:null}
          ]},
        4:{focus:"Rad + Kraft",duration:"90–105 min",load:"moderat",summary:"Rad GA1 + Stabi.",
          details:"• Rad 60–75 min @ 130–165 W\n• Kraft 30 min (Stabi/Beinachse)",
          checklist:[
            {t:"Rad GA1 (60–75 min)",d:"130–165 W, rpm 85–95, gleichmäßig.",libKey:"bike_ga1"},
            {t:"Bodyweight Kraft (30 min)",d:"Stabi/Beinachse.",libKey:"strength_bw"}
          ]},
        5:{focus:"Schwimmen Key",duration:"55–60 min",load:"moderat",summary:"Key Swim 55 min (Rotation).",
          details:"• Swim Freitag 55 min ("+rotName+")\n• Optional Mobility kurz",
          checklist:[
            {t:"Schwimmen Freitag (55 min)",d:"Key Swim (Rotation: "+rotName+").",libKey:"swim_fri"},
            {t:"Optional Mobility/Reha (10 min)",d:"Nur wenn du dich steif fühlst.",libKey:"mobility_reha"}
          ]},
        6:{focus:"Lange Ausfahrt",duration:"2–3 h (+ 5–10 min)",load:"hoch",summary:"Rad lang GA1, optional Koppellauf.",
          details:"• Rad 2–3 h @ 130–165 W\n• Optional Koppellauf 5–10 min",
          checklist:[
            {t:"Rad lang GA1 (2–3 h)",d:"Fueling beachten, gleichmäßig.",libKey:"bike_long"},
            {t:"Optional Koppellauf (5–10 min)",d:"Nur wenn Knie 0–1/10.",libKey:"brick_optional"}
          ]},
        0:{focus:"Lauf + Mobility",duration:"50–60 min",load:"moderat",summary:"Lauf locker + Mobility.",
          details:"• Lauf "+runMin+" min easy\n• Mobility 10–15 min",
          checklist:[
            {t:"Lauf easy ("+runMin+" min)",d:runDesc,libKey:"run_easy"},
            {t:"Mobility/Reha (10–15 min)",d:"Bauernfeind-App.",libKey:"mobility_reha"}
          ]}
      };
    }

    // ---------- persistence ----------
    function keyFor(iso, suffix){ return "tri_"+iso+"_"+suffix; }
    function getLS(k){ if(!storageOK) return null; try{ return localStorage.getItem(k); }catch(e){ return null; } }
    function setLS(k,v){ if(!storageOK) return false; try{ localStorage.setItem(k,v); return true; }catch(e){ return false; } }
    function delLS(k){ if(!storageOK) return false; try{ localStorage.removeItem(k); return true; }catch(e){ return false; } }

    function getNotes(iso){ return getLS(keyFor(iso,"notes")) || ""; }
    function setNotes(iso, v){ return setLS(keyFor(iso,"notes"), v); }
    function getOverride(iso){ return getLS(keyFor(iso,"override")) || ""; }
    function setOverride(iso, v){ return setLS(keyFor(iso,"override"), v); }
    function clearOverride(iso){ return delLS(keyFor(iso,"override")); }
    function getChecks(iso){
      var raw = getLS(keyFor(iso,"checks")) || "{}";
      try{ return JSON.parse(raw); }catch(e){ return {}; }
    }
    function setChecks(iso, obj){ return setLS(keyFor(iso,"checks"), JSON.stringify(obj)); }

    function getDoneLibArr(iso){
      var raw = getLS(doneKeyFor(iso));
      if(!raw) return [];
      try{
        var arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function setDoneLibArr(iso, arr){
      return setLS(doneKeyFor(iso), JSON.stringify(arr));
    }
    function markLibDone(iso, libKey, done){
      if(!libKey) return;
      var arr = getDoneLibArr(iso);
      var idx = arr.indexOf(libKey);
      if(done && idx < 0) arr.push(libKey);
      if(!done && idx >= 0) arr.splice(idx,1);
      setDoneLibArr(iso, arr);
    }

    // ---------- modal ----------
    var modalOverlay = $("modalOverlay");
    var modalClose   = $("modalClose");
    var modalTitle   = $("modalTitle");
    var modalChips   = $("modalChips");
    var modalIntro   = $("modalIntro");
    var modalContent = $("modalContent");
    var modalRules   = $("modalRules");

    function openModal(libKey, date){
      var LIB = LIB_FOR_DATE(date || new Date());
      if(!libKey || !LIB[libKey]){
        safeText(modalTitle, "Info");
        modalChips.innerHTML = "";
        safeText(modalIntro, "Für diese Position gibt es keine Detail-Anleitung.");
        modalContent.innerHTML = "<div class='small'>Wenn du willst, kann ich das nachtragen.</div>";
        safeText(modalRules, "");
      } else {
        var x = LIB[libKey];
        safeText(modalTitle, x.title);
        modalChips.innerHTML = "";
        for(var i=0;i<(x.chips||[]).length;i++){
          var c = document.createElement("div");
          c.className = "chip";
          c.textContent = x.chips[i];
          modalChips.appendChild(c);
        }
        safeText(modalIntro, x.intro || "");
        modalContent.innerHTML = x.content || "";
        safeText(modalRules, x.rules || "");
      }
      modalOverlay.style.display = "flex";
      modalOverlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modalOverlay.style.display = "none";
      modalOverlay.setAttribute("aria-hidden","true");
    }
    modalClose.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", function(e){
      if(e.target === modalOverlay) closeModal();
    });
    document.addEventListener("keydown", function(e){
      if(e.key === "Escape") closeModal();
    });

    // ---------- rendering ----------
    var currentDate = new Date();

    function renderWeekTable(){
      var tbody = $("weekRows");
      tbody.innerHTML = "";
      var order = [1,2,3,4,5,6,0];
      var names = {0:"So",1:"Mo",2:"Di",3:"Mi",4:"Do",5:"Fr",6:"Sa"};
      var plan = buildPlanForDate(currentDate);

      for(var i=0;i<order.length;i++){
        var idx = order[i];
        var p = plan[idx];
        var tr = document.createElement("tr");
        tr.innerHTML = "<td><strong>"+names[idx]+"</strong></td><td>"+p.summary+"</td><td>"+p.duration+"</td>";
        tbody.appendChild(tr);
      }
    }

    function renderOverrideSelect(){
      var sel = $("overrideSelect");
      sel.innerHTML = "";
      var opts = [
        {v:"", label:"— keine Änderung —"},
        {v:"rest", label:"Restday (kein Sport)"},
        {v:"1", label:"Montag – Kraft+Mobility"},
        {v:"2", label:"Dienstag – Lauf+Kraft+Mobility"},
        {v:"3", label:"Mittwoch – Swim+Tennis"},
        {v:"4", label:"Donnerstag – Rad+Kraft"},
        {v:"5", label:"Freitag – Swim Key"},
        {v:"6", label:"Samstag – Rad lang (+ optional Koppellauf)"},
        {v:"0", label:"Sonntag – Lauf+Mobility"}
      ];
      for(var i=0;i<opts.length;i++){
        var op = document.createElement("option");
        op.value = opts[i].v;
        op.textContent = opts[i].label;
        sel.appendChild(op);
      }
    }

    function updateFooter(){
      var iso = toISODate(currentDate);
      var checks = getChecks(iso);
      var done = 0;
      for(var k in checks){ if(Object.prototype.hasOwnProperty.call(checks,k) && checks[k]) done++; }
      safeText($("footerHint"), iso + " · erledigt: " + done + " · Run-Progress: " + runMinutesFor(currentDate) + " min");
    }

    function renderSwimRotationInfo(){
      var b = getCurrentSwimBlock(currentDate);
      var start = new Date(currentDate.getTime());
      start.setDate(start.getDate() - (daysBetween(SWIM_ANCHOR, currentDate) % 14));
      var end = addDays(start, 13);
      safeText($("swimRotationInfo"),
        "Aktuell: " + b.name + " | Drills: " + b.drills.map(function(x){return x.name;}).join(", ")
        + " | gültig ca.: " + toISODate(start) + " bis " + toISODate(end)
      );
    }

    function renderLibraryList(){
      var list = $("libList");
      var q = ($("libSearch").value || "").trim().toLowerCase();
      list.innerHTML = "";

      var LIB = LIB_FOR_DATE(currentDate);
      var keys = Object.keys(LIB).sort(function(a,b){
        return (LIB[a].title || a).localeCompare(LIB[b].title || b);
      });

      var shown = 0;
      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        var item = LIB[k];
        var hay = (item.title+" "+(item.intro||"")+" "+(item.chips||[]).join(" ")).toLowerCase();
        if(q && hay.indexOf(q) < 0) continue;

        var div = document.createElement("div");
        div.className = "libItem";
        div.innerHTML = "<p class='name'>"+item.title+"</p>" +
                        "<div class='meta'>"+(item.chips ? item.chips.join(" · ") : "")+"</div>";
        div.addEventListener("click", (function(key){
          return function(){ openModal(key, currentDate); };
        })(k));
        list.appendChild(div);
        shown++;
      }

      if(shown === 0){
        var empty = document.createElement("div");
        empty.className = "section";
        empty.innerHTML = "<div class='small'>Keine Treffer. Tipp: suche z.B. nach „Scull“, „Mobility“, „Run“.</div>";
        list.appendChild(empty);
      }
    }

    function render(){
      var iso = toISODate(currentDate);
      var wd = currentDate.getDay();

      var PLAN = buildPlanForDate(currentDate);
      var ov = getOverride(iso);
      var plan = PLAN[wd];
      var ovText = "Override: keiner";

      if(ov === "rest"){
        plan = {
          focus:"Restday", duration:"0–30 min", load:"leicht",
          summary:"Heute kein Training. Optional Spaziergang + Mobility.",
          details:"• Optional 20–30 min Spaziergang\n• Optional Mobility 10–15 min",
          checklist:[
            {t:"Optional Mobility/Reha (10–15 min)",d:"Nur wenn du steif bist.",libKey:"mobility_reha"}
          ]
        };
        ovText = "Override: Restday";
      } else if(ov !== "" && PLAN[parseInt(ov,10)]){
        plan = PLAN[parseInt(ov,10)];
        ovText = "Override: anderer Trainingstag";
      }

      safeText($("todayDay"), days[wd]);
      safeText($("todayDate"), fmtDate(currentDate));
      safeText($("todaySummary"), plan.summary);
      safeText($("todayDuration"), plan.duration);
      safeText($("todayFocus"), plan.focus);

      var lb = loadLabel(plan.load);
      safeText($("loadText"), lb.text);
      $("loadDot").className = "dot " + lb.cls;

      safeHTML($("todayDetails"), "<pre>"+plan.details+"</pre>");
      safeText($("overrideState"), ovText);
      $("overrideSelect").value = ov;

      var list = $("checklist");
      list.innerHTML = "";
      var checks = getChecks(iso);

      for(var i=0;i<plan.checklist.length;i++){
        (function(i){
          var item = plan.checklist[i];
          var id = "chk_"+i;

          var wrap = document.createElement("div");
          wrap.className = "checkItem";

          var cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = !!checks[id];

          var main = document.createElement("div");
          main.className = "checkMain";

          var title = document.createElement("p");
          title.className = "t";
          title.textContent = item.t;

          var desc = document.createElement("p");
          desc.className = "d";
          desc.textContent = item.d;

          var hint = document.createElement("div");
          hint.className = "hintTap";
          hint.textContent = item.libKey ? "Tippen für Anleitung →" : "";

          main.appendChild(title);
          main.appendChild(desc);
          if(item.libKey) main.appendChild(hint);

          wrap.appendChild(cb);
          wrap.appendChild(main);
          list.appendChild(wrap);

          cb.addEventListener("change", function(){
            var n = getChecks(iso);
            n[id] = !!cb.checked;
            setChecks(iso, n);

            if(item.libKey){
              markLibDone(iso, item.libKey, !!cb.checked);
            }

            updateFooter();
          });

          main.addEventListener("click", function(){
            openModal(item.libKey, currentDate);
          });
        })(i);
      }

      $("notes").value = getNotes(iso);
      safeText($("saveHint"), storageOK ? "Bereit" : "Speichern evtl. blockiert");
      updateFooter();

      renderSwimRotationInfo();
      renderLibraryList();
    }

    function setTab(tab){
      var tabs = document.querySelectorAll(".tab");
      for(var i=0;i<tabs.length;i++){
        tabs[i].classList.remove("active");
        if(tabs[i].getAttribute("data-tab") === tab) tabs[i].classList.add("active");
      }
      $("tab-week").style.display = (tab==="week") ? "block" : "none";
      $("tab-swim").style.display = (tab==="swim") ? "block" : "none";
      $("tab-lib").style.display  = (tab==="lib")  ? "block" : "none";
      if(tab==="lib") renderLibraryList();
      if(tab==="swim") renderSwimRotationInfo();
    }
    var tabEls = document.querySelectorAll(".tab");
    for(var i=0;i<tabEls.length;i++){
      (function(el){
        el.addEventListener("click", function(){ setTab(el.getAttribute("data-tab")); });
      })(tabEls[i]);
    }

    $("libSearch").addEventListener("input", renderLibraryList);
    $("libClear").addEventListener("click", function(){
      $("libSearch").value = "";
      renderLibraryList();
    });

    $("btnReload").addEventListener("click", function(){ location.reload(); });
    $("btnToday").addEventListener("click", function(){ currentDate = new Date(); renderWeekTable(); render(); });
    $("btnPrev").addEventListener("click", function(){ currentDate = addDays(currentDate,-1); renderWeekTable(); render(); });
    $("btnNext").addEventListener("click", function(){ currentDate = addDays(currentDate, 1); renderWeekTable(); render(); });

    $("btnSave").addEventListener("click", function(){
      var iso = toISODate(currentDate);
      var ok = setNotes(iso, $("notes").value);
      safeText($("saveHint"), ok ? "Gespeichert ✅" : "Speichern blockiert ❌");
    });
    $("btnClearNotes").addEventListener("click", function(){
      var iso = toISODate(currentDate);
      setNotes(iso, "");
      $("notes").value = "";
      safeText($("saveHint"), "Notiz gelöscht");
    });

    $("btnSetRest").addEventListener("click", function(){
      setOverride(toISODate(currentDate), "rest"); render();
    });
    $("btnClearOverride").addEventListener("click", function(){
      clearOverride(toISODate(currentDate)); render();
    });
    $("btnApplyOverride").addEventListener("click", function(){
      var iso = toISODate(currentDate);
      var v = $("overrideSelect").value;
      if(v === "") clearOverride(iso); else setOverride(iso, v);
      render();
    });

    $("btnExport").addEventListener("click", function(){
      var out = {};
      out.generated = new Date().toISOString();
      out.note = "Triathlon Export (Notizen/Checks/Overrides/DoneLibKeys)";
      var now = new Date();
      for(var i=0;i<60;i++){
        var d = addDays(now, -i);
        var diso = toISODate(d);
        out["notes_"+diso] = getNotes(diso);
        out["checks_"+diso] = getChecks(diso);
        out["override_"+diso] = getOverride(diso);
        out["doneLib_"+diso] = getDoneLibArr(diso);
      }
      var blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = "triathlon_export.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    renderOverrideSelect();
    renderWeekTable();
    render();
  });
})();
</script>
</body>
</html>
